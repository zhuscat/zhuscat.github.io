<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="ZhusCafe">
<meta property="og:url" content="http://zhuscat.com/index.html">
<meta property="og:site_name" content="ZhusCafe">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZhusCafe">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhuscat.com/"/>





  <title> ZhusCafe </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-83257887-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">ZhusCafe</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/05/01/xss-protection/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/01/xss-protection/" itemprop="url">
                  XSS Protection Summary
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-01T13:06:37+08:00">
                2017-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/前端安全/" itemprop="url" rel="index">
                    <span itemprop="name">前端安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/05/01/xss-protection/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/01/xss-protection/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>XSS 攻击分为 <strong>反射型</strong> 、<strong>存储型</strong> 和 <strong>DOM Based XSS</strong></p>
<h3 id="反射型-XSS"><a href="#反射型-XSS" class="headerlink" title="反射型 XSS"></a>反射型 XSS</h3><p>反射型 XSS 是把用户的输入反射回浏览器所造成的 XSS 攻击，比如说本来网页上有一个表单让用户填用户名，用户提交表单之后返回的响应将用户填写的用户名显示出来。这种类型的攻击，一般攻击者的攻击手段为构造一个 URL 让用户去点击，当用户点击了这个 URL 之后，攻击才能成功。</p>
<p>我们试着去构造这样一个攻击的例子，使用 node.js 搭建一个简单的服务器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> parsedURL = url.parse(request.url, <span class="literal">true</span>);</div><div class="line">  response.setHeader(<span class="string">'X-XSS-Protection'</span>, <span class="number">0</span>);</div><div class="line">  <span class="keyword">if</span> (parsedURL.query.a) &#123;</div><div class="line">    response.end(<span class="string">`&lt;html&gt;&lt;head&gt;&lt;title&gt;返回&lt;/title&gt;&lt;/head&gt;&lt;body&gt;<span class="subst">$&#123;parsedURL.query.a&#125;</span>&lt;/body&gt;&lt;/html&gt;`</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    response.end(<span class="string">'没有提供参数a'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.listen(<span class="number">3002</span>);</div></pre></td></tr></table></figure>
<p>当输入的 URL 中有参数 <code>a</code> 的时候，会将这个参数的值嵌入到 body 作为响应返回到客户端。</p>
<p>注意到，我在返回的头部设置了 <code>X-XSS-Protection: 0</code>，不然 Chrome 会默认拦截可能的 XSS 攻击。</p>
<p>接着我们构造这样一个URL：<code>http://localhost:3002/xss?a=&lt;script&gt;alert(/xss/)&lt;script&gt;</code></p>
<p><img src="http://7xpc78.com1.z0.glb.clouddn.com/xss-protection/reflect.png" alt="反射型XSS"></p>
<h3 id="存储型-XSS"><a href="#存储型-XSS" class="headerlink" title="存储型 XSS"></a>存储型 XSS</h3><p>存储型 XSS，不同于反射型的 XSS 攻击，会将数据存储到数据库，一个比较常见的例子是攻击者发布了一篇包含恶意 JavaScript 代码的文章，所有访问该文章的用户都会受到攻击。</p>
<h3 id="DOM-Based-XSS"><a href="#DOM-Based-XSS" class="headerlink" title="DOM Based XSS"></a>DOM Based XSS</h3><p>DOM Based 通过 JS 操作 DOM 元素造成 XSS（如往事件属性里面写信息），严格来说，DOM Based XSS 也是反射型 XSS 的一种，不过这种攻击不是服务器返回的数据包含了恶意脚本，而是直接在客户端就生成了恶意脚本。还是看一个例子（ <a href="https://www.owasp.org/index.php/DOM_Based_XSS" target="_blank" rel="external">DOM Based XSS - OWASP</a> ）：</p>
<p>假设服务器返回如下所示的 HTML 页面，注意到，OPTION 选项是从用户的链接中提取的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Select your language:</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">select</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line"><span class="built_in">document</span>.write(<span class="string">"&lt;OPTION value=1&gt;"</span>+<span class="built_in">document</span>.location.href.substring(<span class="built_in">document</span>.location.href.indexOf(<span class="string">"default="</span>)+<span class="number">8</span>)+<span class="string">"&lt;/OPTION&gt;"</span>);</div><div class="line"></div><div class="line"><span class="built_in">document</span>.write(<span class="string">"&lt;OPTION value=2&gt;English&lt;/OPTION&gt;"</span>);</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
<p>正常的链接应该是这个样子的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.some.site/page.html?default=French</div></pre></td></tr></table></figure>
<p>然而，攻击者可以构造一个这样的 URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.some.site/page.html?default=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>当用户点击了这样一个 URL 之后，攻击就成功了，浏览器会执行下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alert(<span class="built_in">document</span>.cookie)</div></pre></td></tr></table></figure>
<h2 id="如何防范"><a href="#如何防范" class="headerlink" title="如何防范"></a>如何防范</h2><h3 id="给-Cookie-设置-HttpOnly"><a href="#给-Cookie-设置-HttpOnly" class="headerlink" title="给 Cookie 设置 HttpOnly"></a>给 Cookie 设置 HttpOnly</h3><p>很多 XSS 攻击想要获取用户的 cookie，一般会获取 cookie 然后传送到攻击者的服务器上，然后可以以该用户的身份做一些操作（当然并不是所有都需要），给 Cookie 设置 HttpOnly 之后，JavaScript 就不能读取 Cookie 了。</p>
<h3 id="输入检查"><a href="#输入检查" class="headerlink" title="输入检查"></a>输入检查</h3><p>输入检查做的是过滤用户可能会造成 XSS 攻击的输入，比如说用户的用户名填写只能是数字加字母，如果要做输入检查，服务器端必须要有输入检查的逻辑，另外，客户端也可以做输入检查的逻辑，可以将正常用户的不小心的输入直接排除，不仅增强了用户体验，还减轻了服务器的压力。<br>但是，输入检查不是万能的，比如说一个可以让用户自定义 script 标签的 URL 的地方，此时，攻击者大可以输入一个指向恶意脚本的地址，服务器很难判别这是否是恶意的脚本。</p>
<h3 id="输出检查"><a href="#输出检查" class="headerlink" title="输出检查"></a>输出检查</h3><p>输出检查是在输出的时候进行过滤或者转义。<br>根据输出位置的不同，我们需要有不同的策略来进行文本的转义，切不可只使用一种转义的方法就觉得万事大吉了。<br>很多后端框架支持默认的转义，一般会对变量进行 HTML 转义，不过，即使是这样，仍然有可能存在着 XSS 漏洞。<br>比如说用户可以在如下 HTML 中输入变量：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"alert('$var');"</span>&gt;</span>CLICK ME<span class="tag">&lt;<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure>
<p>如果攻击者输入如下字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1&apos;);alert(&apos;2</div></pre></td></tr></table></figure>
<p>经过转义之后变为如下的字符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1&amp;#x27;&amp;#x29;;&amp;#x3B;alert&amp;#x28;&amp;#x27;2</div></pre></td></tr></table></figure>
<p><img src="http://7xpc78.com1.z0.glb.clouddn.com/xss-protection/xss-in-event-handler.png" alt="插入事件属性的变量"></p>
<p>即使这样，仍然会发现浏览器的行为为 <code>alert(1)</code> 和 <code>alert(2)</code>，究其原因，onclick 中的数据会先经过浏览器的解析，此时又成为了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alert(<span class="string">'1'</span>);alert(<span class="string">'2'</span>);</div></pre></td></tr></table></figure>
<p>自然攻击能够成功。</p>
<p>因此，我们需要对在不同情况下的输出做不同的转移：</p>
<p>1.在 HTML 标签之间输出，对这些数据进行 HTML Entity 编码</p>
<p><strong>编码规则</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&amp; -&gt; &amp;amp;</div><div class="line">&lt; -&gt; &amp;lt;</div><div class="line">&gt; -&gt; &amp;gt;</div><div class="line">&quot; -&gt; &amp;quot;</div><div class="line">&apos; -&gt; &amp;#x27;</div><div class="line">/ -&gt; &amp;#x2f;</div></pre></td></tr></table></figure>
<p>2.要将不可信数据插入到HTML属性里时，对这些数据进行HTML属性编码</p>
<p><strong>编码规则</strong></p>
<p>除了阿拉伯数字和字母，对其他所有字符进行编码。编码后输出为 <code>&amp;#xHH;</code> HH 为对应的十六进制数字，分号作为结束符。<br>防止在属性值进行构造关闭当前标签。然后自己的标签就可以作为 HTML 实体插入了。</p>
<p>3.在将不可信数据插入到 script 里时，对这些数据进行 script 编码</p>
<p><strong>编码规则</strong></p>
<p>除了阿拉伯数字和字母，对其他所有字符进行编码。编码后输出的格式为 <code>\xHH</code>。</p>
<p>不要用反斜杠对特殊字符进行转义。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> message = <span class="string">"&#123;&#123;data&#125;&#125;"</span>;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>攻击者输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\&quot;; alert(&apos;xss&apos;);//</div></pre></td></tr></table></figure></p>
<p>结果渲染上去之后是<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">var</span> message = <span class="string">"\\"</span>; alert(<span class="string">'xss'</span>);<span class="comment">//</span></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.在将不可信数据插入到 style 属性里时，对这些数据进行 CSS 编码</p>
<p>除了阿拉伯数字和字母，对其他所有字符进行转义，转移之后变为形如 <code>\HH</code> 的字符。</p>
<p>5.在将不可信数据插入到 HTML URL 里时，对这些数据进行 URL 编码<br>除了阿拉伯数字和字母，对其他所有字符进行转义，转义之后变为形如  <code>%HH</code>  的字符。</p>
<p>对URL进行编码的时候的注意点：</p>
<ol>
<li>URL属性用引号包含起来</li>
<li>不要对整个URL进行编码，因为不可信数据会插入到 href src 或其他以URL为基础的属性里面，并且要对协议字段进行认证，否则攻击者可以改变协议，如  <code>data</code>  协议或者  <code>javascript</code>  伪协议</li>
</ol>
<p>6.使用富文本时，使用 XSS 规则引擎进行编码过滤，使用白名单策略</p>
<p>针对富文本的特殊性，我们可以使用XSS规则引擎对用户输入进行编码过滤，只允许用户输入安全的HTML标签，如 <code>&lt;b&gt;</code>，<code>&lt;i&gt;</code>， <code>&lt;p&gt;</code>等，对其他数据进行 HTML 编码。需要注意的是，经过规则引擎编码过滤后的内容只能放在 <code>&lt;div&gt;</code>， <code>&lt;p&gt;</code>  等安全的HTML标签里，不要放到 HTML 标签的属性值里，更不要放到HTML 事件处理属性里，或者放到  <code>&lt;script&gt;</code> 标签里。</p>
<p>如下就是是一个 XSS 过滤工具<br> <a href="https://github.com/leizongmin/js-xss" target="_blank" rel="external">GitHub - leizongmin/js-xss: Sanitize untrusted HTML (to prevent XSS) with a configuration specified by a Whitelist</a></p>
<h4 id="DOM-Based-XSS-1"><a href="#DOM-Based-XSS-1" class="headerlink" title="DOM Based XSS"></a>DOM Based XSS</h4><p>DOM Based XSS 的攻击方法是在 JavaScript 将内容写到 HTML 页面中，一般在返回的页面中可能已经对 JavaScript 中的变量进行转义了，但在 script 标签执行的时候，内容又会被解码，然后输出到 HTML 中。因此防御 DOM Based XSS 的时候，一个重要的关注点是在 JavaScript 输出的时候对其进行再次的转义，转义的方案与上面所述相同。</p>
<h4 id="使用-XSS-安全相关的头部"><a href="#使用-XSS-安全相关的头部" class="headerlink" title="使用 XSS 安全相关的头部"></a>使用 XSS 安全相关的头部</h4><p>1.X-XSS-Protection</p>
<p>浏览器默认开启了 XSS 保护，可以使用这个头部关闭这种特性，一般不需要关闭：</p>
<ul>
<li>0：禁用XSS保护</li>
<li>1：启用XSS保护</li>
<li>1：mode=block：启用XSS保护，并在检查到XSS攻击时，停止渲染页面</li>
</ul>
<p>2.Content-Security-Policy</p>
<p>使用 Content-Security-Policy 可以限制页面可以加载哪些内容</p>
<p>欢迎大家探讨交流，有错误请指正。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li>《白帽子将 Web 安全》</li>
<li><a href="https://imququ.com/post/web-security-and-response-header.html" target="_blank" rel="external">一些安全相关的HTTP响应头 | JerryQu 的小站</a></li>
<li><a href="https://imququ.com/post/content-security-policy-reference.html" target="_blank" rel="external">Content Security Policy 介绍 | JerryQu 的小站</a></li>
<li><a href="https://github.com/leizongmin/js-xss" target="_blank" rel="external">GitHub - leizongmin/js-xss: Sanitize untrusted HTML (to prevent XSS) with a configuration specified by a Whitelist</a></li>
<li><a href="https://www.owasp.org/index.php/DOM_Based_XSS" target="_blank" rel="external">DOM Based XSS</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/03/12/async-file-upload/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/12/async-file-upload/" itemprop="url">
                  异步文件上传
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-12T23:53:06+08:00">
                2017-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学以致用/" itemprop="url" rel="index">
                    <span itemprop="name">学以致用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/03/12/async-file-upload/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/12/async-file-upload/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用-iframe-进行文件的异步上传"><a href="#使用-iframe-进行文件的异步上传" class="headerlink" title="使用 iframe 进行文件的异步上传"></a>使用 iframe 进行文件的异步上传</h2><p>使用 <code>iframe</code> 进行文件的异步上传的基本思想是在表单上传的时候，创建一个 <code>iframe</code> 元素，并将表单的 <code>target</code> 属性设置为创建的 <code>iframe</code> 窗口，这样，上传结束返回的数据会到 <code>iframe</code> 窗口里面，页面也不会发生转跳。</p>
<p>废话不多说，来看看代码：</p>
<p>首先是基本的表单</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"myform"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">action</span>=<span class="string">"/someurl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"myfile"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接着再看看 <code>JavaScript</code> 代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 用于生成 iframe 窗口 name 属性</span></div><div class="line"><span class="keyword">var</span> seed = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> myform = <span class="built_in">document</span>.getElementById(<span class="string">'myform'</span>);</div><div class="line">myform.onsubmit = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</div><div class="line">  <span class="keyword">var</span> id = <span class="string">'uploader-frame-'</span> + seed;</div><div class="line">  seed++;</div><div class="line">  iframe.setAttribute(<span class="string">'name'</span>, id);</div><div class="line">  <span class="comment">// 隐藏 iframe</span></div><div class="line">  iframe.style.cssText = <span class="string">'display: none'</span>;</div><div class="line">  <span class="comment">// 设置 form 的 target 为 iframe</span></div><div class="line">  myform.setAttribute(<span class="string">'target'</span>, id);</div><div class="line">  <span class="comment">// 将 iframe 插入</span></div><div class="line">  <span class="built_in">document</span>.body.appendChild(iframe);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是这么简单，不过服务器成功接收数据后返回需要返回一段数据，这里一般是要触发一个回调，我们可以与服务器预先约定好回调函数的名字，或者在上传表单的 <code>URL</code> 中加参数之类的，反正让服务器端知道回调函数的名字就好了，一般可以这样返回：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">res.write(<span class="string">'&lt;script&gt;window.top.callback("somedata")&lt;/script&gt;'</span>);</div><div class="line">res.end();</div></pre></td></tr></table></figure>
<p>这样就会调用 <code>callback</code> 函数了，<code>iframe</code> 异步上传表单的优点是兼容性较高。下面再看看另一种异步上传表单的方式。</p>
<h2 id="AJAX-上传"><a href="#AJAX-上传" class="headerlink" title="AJAX 上传"></a>AJAX 上传</h2><p><code>XMLHttpRequest</code> 对象第二版支持异步上传文件，方法是使用 <code>FormData</code>，然后向服务器端发送数据。</p>
<p>让我们看看代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</div><div class="line">formData.append(<span class="string">'myfile'</span>, <span class="built_in">document</span>.getElementById(<span class="string">'myfile'</span>).files[<span class="number">0</span>]);</div><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.open(<span class="string">'POST'</span>, <span class="string">'/someurl'</span>);</div><div class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</div><div class="line">    <span class="comment">// 上传成功</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 出现错误</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">xhr.send(formData);</div></pre></td></tr></table></figure>
<p>就是这么简单，并且十分强大。</p>
<p>另外，借助 <code>File API</code> + <code>AJAX</code> 的方式，还能实现更多高级的功能，比如断点续传，思路就是使用 <code>File.prototype.slice</code> 将文件分割成多个片段，然后使用 <code>AJAX</code> 传送片段，如果一个片段传送成功了就传送下一个片段。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/02/27/drag/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/27/drag/" itemprop="url">
                  drag
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-27T13:13:14+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/02/27/drag/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/27/drag/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>当拖动某一个元素的时候，将会先后触发 <code>dragstart</code>，<code>drag</code>，<code>dragend</code> 事件。</p>
<p>当某个元素被拖到有效放置目标上时，先后触发 <code>dragenter</code>，<code>dragover</code>，<code>drop</code>或<code>dragleave</code>。</p>
<p>某些元素不允许被放置，这个时候取消这些元素 <code>dragenter</code> 和 <code>dragover</code> 的默认行为就可以将该元素转为可被放置的目标。</p>
<p>另外，一些元素有默认的放置行为，这个时候，将 <code>drop</code> 的默认行为去除就行了。</p>
<p>要把一个元素设置为可拖动的，可以按照如下设置：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/02/27/drag/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/02/19/add-operator/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/19/add-operator/" itemprop="url">
                  加号操作符
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-19T17:50:55+08:00">
                2017-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/02/19/add-operator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/19/add-operator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>加法操作符的规则：</p>
<ol>
<li>如果操作符中有一个是对象，将其转换为原始值</li>
<li>如果操作数中有一个是字符串，将另一个也转换为字符串，然后连接</li>
<li>其他情况下，将两个操作数转换为数字并执行加法运算</li>
</ol>
<p>首先看一下第一条规则，如果操作符中有一个是对象，将其转换为原始值，那么，是如何转换的呢？</p>
<ol>
<li>如果对象是 <code>Date</code> 类型的话，使用 <code>toString()</code> 转换为字符串</li>
<li>其他对象的话会先调用 <code>valueOf()</code>，如果返回的是一个原始值得话，则使用这个原始值，否则进入第三部</li>
<li>调用 <code>toString()</code> 方法</li>
</ol>
<p>好了，我们再看几个例子</p>
<h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ret = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] + <span class="number">4</span>; <span class="comment">// '1,2,34'</span></div></pre></td></tr></table></figure>
<p><code>[1, 2, 3]</code> 是一个对象，因此先调用 <code>valueOf()</code>，但 函数返回的是数组本身，不是一个原始值，因此再调用 <code>toString()</code>，返回字符串<code>&#39;1,2,3&#39;</code>。</p>
<p>此时表达式变为 <code>&#39;1,2,3&#39; + 4</code>，此时使用第二条规则，将数字<code>4</code>转化为字符串<code>&#39;4&#39;</code>。</p>
<p>此时表达式变为<code>&#39;1,2,3&#39; + &#39;4&#39;</code>，结果为<code>1,2,34</code>。</p>
<h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ret = [] + <span class="number">1</span>; <span class="comment">// '1'</span></div></pre></td></tr></table></figure>
<p><code>[]</code>转换为字符串<code>&#39;&#39;</code>，<code>1</code>转换为<code>&#39;1&#39;</code>，因此结果为<code>&#39;1&#39;</code></p>
<h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ret = <span class="literal">true</span> + <span class="number">1</span> <span class="comment">// 2</span></div></pre></td></tr></table></figure>
<p>执行第三条规则，<code>true</code>转换为<code>1</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/01/05/solve-problem-cannot-overwrite-model-once-compiled/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/05/solve-problem-cannot-overwrite-model-once-compiled/" itemprop="url">
                  mongoose Cannot overwrite model once compiled
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-05T14:35:12+08:00">
                2017-01-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学以致用/" itemprop="url" rel="index">
                    <span itemprop="name">学以致用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/05/solve-problem-cannot-overwrite-model-once-compiled/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/05/solve-problem-cannot-overwrite-model-once-compiled/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前使用了 <a href="https://github.com/wssgcg1213/koa2-react-isomorphic-boilerplate" target="_blank" rel="external">koa2-react-isomorphic-boilerplate</a> 作为编写前后端同构应用，但是使用这个 boilerplate 的时候出现了一个问题：我使用了一个库 <code>mongoose</code>，每次在 <code>development</code> 模式下修改代码的时候就会抛出错误，错误原因就是 <code>Cannot overwrite model once compiled.</code>，然后只能自己重启服务器。 </p>
<p>然后就就想着要不就修改代码之后重启服务器吧。之后又参考了几个前后端同构的 boilerplate，自己写了个 boilerplate，大概就是服务器端代码修改时候自动重启，客户端代码修改进行热替换。然而，这带来的一个问题是客户端代码修改之后，当刷新页面时候服务端返回的html与客户端生成的是不一致的，在这个 <a href="https://github.com/chikara-chan/react-isomorphic-boilerplate/issues/1#issuecomment-270562613" target="_blank" rel="external">issue</a> 中我有提到。接着我突然想到，<a href="https://github.com/wssgcg1213/koa2-react-isomorphic-boilerplate" target="_blank" rel="external">koa2-react-isomorphic-boilerplate</a> 是可以在客户端代码修改后也修改服务器端返回的代码的，具体实现就是通过清除 <code>require</code> 缓存，至于为什么 <code>mongoose</code> 会报这个重复定义的错呢，我再次查阅了一些资料，发现 <code>mongoose</code> 会缓存 <code>model</code> 和 <code>modelSchema</code> 在 <code>mongoose.models</code> 和 <code>mongoose.modelSchemas</code> 上面，当清除 <code>require</code> 的缓存之后，<code>mongoose.models</code> 里面的东西还在，然后再次 <code>require</code> 模型的时候就报错了。</p>
<p>因此，我通过在监听文件变动的代码里再加上下面的代码来清除 <code>mongoose</code> 中的缓存，成功地解决了这个问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.keys(mongoose.models).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">model</span>) </span>&#123;</div><div class="line">  <span class="keyword">delete</span> mongoose.models[model];</div><div class="line">&#125;)</div><div class="line"><span class="built_in">Object</span>.keys(mongoose.modelSchemas).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">schema</span>) </span>&#123;</div><div class="line">  <span class="keyword">delete</span> mongoose.modelSchemas[schema];</div><div class="line">&#125;)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2017/01/04/solve-problem-property-key-of-objectproperty/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/04/solve-problem-property-key-of-objectproperty/" itemprop="url">
                  解决 Property key of ObjectProperty expected node to be of a type ["Identifier","StringLiteral","NumericLiteral"] but instead got "BooleanLiteral" 的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T23:45:31+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学以致用/" itemprop="url" rel="index">
                    <span itemprop="name">学以致用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/04/solve-problem-property-key-of-objectproperty/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/04/solve-problem-property-key-of-objectproperty/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>今天在写 <a href="https://github.com/zhuscat/react-koa-isomorphic-boilerplate">react-koa-isomorphic-boilerplate</a>，期间出现了一个问题，错误原因是 <code>Property key of ObjectProperty expected node to be of a type [&quot;Identifier&quot;,&quot;StringLiteral&quot;,&quot;NumericLiteral&quot;] but instead got &quot;BooleanLiteral&quot;</code>，很快就找到错误所在的地方，但是一直不知道如何解决这个错误，然后通过各种尝试总算是解决了这个错误，但是还是不知道错误的根本原因是什么，找个时间研究一下，下面就详细介绍一下这个问题的解决办法吧。</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/01/04/solve-problem-property-key-of-objectproperty/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2016/12/31/2016-movie-book/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016-movie-book/" itemprop="url">
                  2016年我的影视与书籍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T21:08:56+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/31/2016-movie-book/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/31/2016-movie-book/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>新的一年就要来了，想起博客开通也有1年多的时间了吧。年末，写篇文章总结一下这一年来我看的影片与书吧。</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/12/31/2016-movie-book/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2016/12/12/inherited-property-and-non-inherited-property/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/inherited-property-and-non-inherited-property/" itemprop="url">
                  继承属性与非继承属性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-12T16:37:39+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/12/inherited-property-and-non-inherited-property/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/12/inherited-property-and-non-inherited-property/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CSS 属性可以分为继承属性与非继承属性。这决定着当某一属性没有提供值得时候，该属性的值为什么。</p>
<h2 id="继承属性"><a href="#继承属性" class="headerlink" title="继承属性"></a>继承属性</h2><p>CSS 继承属性是在没有给元素指定某一属性的时候，该属性的值为属性父元素该值得计算值。</p>
<p>看下面的代码，可以看到 <code>color</code> 是继承属性，所以 <code>span</code> 里面的颜色也变为蓝色，而 <code>border</code> 是非继承属性，所以 <code>span</code> 并没有边框。</p>
<iframe scrolling="no" width="100%" height="300" src="http://jsfiddle.net/zhuscat/ovqkLxx7/embedded/html,css,result/light" frameborder="0" allowfullscreen></iframe>
<p>下面是一个继承属性的列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">azimuth</div><div class="line">border-collapse</div><div class="line">border-spacing</div><div class="line">caption-side</div><div class="line">color</div><div class="line">cursor</div><div class="line">direction</div><div class="line">elevation</div><div class="line">empty-cells</div><div class="line">font-family</div><div class="line">font-size</div><div class="line">font-style</div><div class="line">font-variant</div><div class="line">font-weight</div><div class="line">font</div><div class="line">letter-spacing</div><div class="line">line-height</div><div class="line">list-style-image</div><div class="line">list-style-position</div><div class="line">list-style-type</div><div class="line">list-style</div><div class="line">orphans</div><div class="line">pitch-range</div><div class="line">pitch</div><div class="line">quotes</div><div class="line">richness</div><div class="line">speak-header</div><div class="line">speak-numeral</div><div class="line">speak-punctuation</div><div class="line">speak</div><div class="line">speech-rate</div><div class="line">stress</div><div class="line">text-align</div><div class="line">text-indent</div><div class="line">text-transform</div><div class="line">visibility</div><div class="line">voice-family</div><div class="line">volume</div><div class="line">white-space</div><div class="line">widows</div><div class="line">word-spacing</div></pre></td></tr></table></figure>
<h2 id="非继承属性"><a href="#非继承属性" class="headerlink" title="非继承属性"></a>非继承属性</h2><p>非继承属性当没有指定值得时候，为该属性的初始值(可在CSS文档中看到一个属性初始值为什么)。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2016/12/11/koa/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/11/koa/" itemprop="url">
                  阅读 Koa 源码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-11T18:34:16+08:00">
                2016-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/11/koa/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/11/koa/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前阅读了 <code>co</code> 的源码，其实一开始就是想看一下 <code>koa</code> 的源码，然后 <code>koa</code> 又是基于 <code>co</code> 构建的，所以先读了一下 <code>co</code>，这次再来记录一下 <code>koa</code> 源码中的东西。</p>
<h2 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h2><p><code>compose</code> 方法返回一个 <code>Generator</code> 函数，将所有 <code>middleware</code> 串联起来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">middleware</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>)</span>&#123;</div><div class="line">      <span class="comment">// ...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先， 判断 <code>next</code> 是否为空，如果为空则将 <code>next</code> 赋值为 <code>noop</code>（空函数）。</p>
<p>接着逆序遍历 <code>middleware</code>，把 <code>middleware</code> 数组中的后一个产生的 <code>iterator</code> 作为前一个 <code>middleware</code> 的参数。</p>
<p>最后，<code>yield *</code> 第一个 <code>next</code>。</p>
<p>理解这个函数，就明白在中间件中 <code>yield next</code> 是怎么工作的了，因为数组中后一个会把产生的 <code>iterator</code> （也就是 <code>next</code>）传给前一个。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">middleware</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (!next) next = noop();</div><div class="line"></div><div class="line">    <span class="keyword">var</span> i = middleware.length;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">      next = middleware[i].call(<span class="keyword">this</span>, next);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">yield</span> *next;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>先来看看 <code>Application</code> 的构造函数，注意到 <code>middleware</code>， <code>context</code>，<code>request</code> 和 <code>response</code>。<code>Context</code>，<code>Request</code> 和 <code>Response</code> 都是 <code>Koa</code> 下面自定义的三个类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Application</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Application)) <span class="keyword">return</span> <span class="keyword">new</span> Application;</div><div class="line">  <span class="keyword">this</span>.env = process.env.NODE_ENV || <span class="string">'development'</span>;</div><div class="line">  <span class="keyword">this</span>.subdomainOffset = <span class="number">2</span>;</div><div class="line">  <span class="keyword">this</span>.middleware = [];</div><div class="line">  <span class="keyword">this</span>.proxy = <span class="literal">false</span>;</div><div class="line">  <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context);</div><div class="line">  <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</div><div class="line">  <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Application-use"><a href="#Application-use" class="headerlink" title="Application#use"></a>Application#use</h3><p>这个函数就是检查 <code>fn</code> 的合法性，然后把 <code>fn</code> 添加到 <code>middleware</code> 数组里面，返回 <code>this</code> 可以让这个函数链式调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">app.use = <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.experimental) &#123;</div><div class="line">    <span class="comment">// es7 async functions are not allowed,</span></div><div class="line">    <span class="comment">// so we have to make sure that `fn` is a generator function</span></div><div class="line">    assert(fn &amp;&amp; <span class="string">'GeneratorFunction'</span> == fn.constructor.name, <span class="string">'app.use() requires a generator function'</span>);</div><div class="line">  &#125;</div><div class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</div><div class="line">  <span class="keyword">this</span>.middleware.push(fn);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="Application-callback"><a href="#Application-callback" class="headerlink" title="Application#callback"></a>Application#callback</h3><p>调用 <code>callback</code> 函数返回的是一个形似 <code>function(res, req) {}</code> 的函数。这个返回的函数传给 <code>http.createServer</code>。</p>
<p>让我们仔细看一下 <code>callback</code>，首先，调用 <code>compose</code> 将 <code>middleware</code> 变为一个 <code>Generator</code> 函数，然后使用 <code>co.wrap</code> 将其变为一个返回 <code>Promise</code> 的函数。关于 <code>co</code> 的讨论，可以看我写的另一篇文章 <a href="http://zhuscat.com">阅读 co 源码</a>。</p>
<p>接着保存 <code>this</code> 给 <code>self</code>。</p>
<p>注意到 <code>this.listeners(&#39;error&#39;).length</code> 这段代码，<code>Application.prototype</code> 的原型是 <code>EventEmitter.prototype</code>，因此拥有这个属性。</p>
<p>接着就是返回这个回调函数了，<code>onFinished</code> 是在一个 HTTP 请求关闭，结束或者出现错误的时候调用的，这里我们传入了 <code>ctx.onerror</code>，<code>createContext</code> 所做的就是创建一个 <code>Context</code> 对象，然后创建 <code>Request</code> 和 <code>Response</code> 对象，并将它们进行一系列的关联。</p>
<p>可以看到下面还有一个 <code>respond.call(ctx)</code>，<code>respond</code> 是一个关于 <code>Response</code> 的帮助函数，最终结束掉响应。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">app.callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.experimental) &#123;</div><div class="line">    <span class="built_in">console</span>.error(<span class="string">'Experimental ES7 Async Function support is deprecated. Please look into Koa v2 as the middleware signature has changed.'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">var</span> fn = <span class="keyword">this</span>.experimental</div><div class="line">    ? compose_es7(<span class="keyword">this</span>.middleware)</div><div class="line">    : co.wrap(compose(<span class="keyword">this</span>.middleware));</div><div class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">handleRequest</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">    res.statusCode = <span class="number">404</span>;</div><div class="line">    <span class="keyword">var</span> ctx = self.createContext(req, res);</div><div class="line">    onFinished(res, ctx.onerror);</div><div class="line"></div><div class="line">    fn.call(ctx).then(<span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">      respond.call(ctx);</div><div class="line">    &#125;).catch(ctx.onerror);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p><code>Context</code> 类（准确来说是用作一个原型）作为一个上下文，提供了到 <code>Response</code> 对象和 <code>Request</code> 对象的代理。</p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>提供了一系列与请求相关的方法。</p>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><p>提供了一系列与响应相关的方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后附上一个 <code>Koa</code> 调用的流程</p>
<p><img src="http://7xpc78.com1.z0.glb.clouddn.com/koa/koa-flowchart.png" alt="Koa Flowcahrt"></p>
<p><code>Koa</code> 是一个非常轻量级的 Web 框架，连路由都没有提供，去看它的源码的时候，发现居然只有4个文件，每个文件代码都不多，并且有许多注释，比较容易阅读。正是这样一个轻量级的框架，配合大量的中间件，可以构建出一个功能强大的应用，这也许就是 Koa 的魅力所在吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://zhuscat.com/2016/12/10/co/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhuscat">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ZhusCafe">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ZhusCafe" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/co/" itemprop="url">
                  阅读 co 源码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-10T08:41:29+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学以致用/" itemprop="url" rel="index">
                    <span itemprop="name">学以致用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/10/co/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/10/co/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>阅读了一下 <code>co</code> 的源码，发现其实做法跟我之前看的《你不知道的 JavaScript》中的 Generator + Promise 一节类似。正好巩固了一下这方面的知识，顺便做一些记录。</p>
<p><code>co</code> 的源码不多，和注释加起来也才两百多行。其中，一个核心函数就是 <code>co</code> 了， <code>co</code> 可以将 <code>Generator</code> 进行自动的执行，本文就来讲一讲 <code>co</code> 是怎么实现自动运行 <code>Generator</code> 的。</p>
          <!--noindex-->
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/12/10/co/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="zhuscat" />
          <p class="site-author-name" itemprop="name">zhuscat</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">65</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">63</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhuscat" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/iwenzhou" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/48336573/" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Douban
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://segmentfault.com/u/zhuscat" target="_blank" title="SegmentFault">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  SegmentFault
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/6781541/zhuscat" target="_blank" title="StackOverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                  StackOverflow
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhuscat</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhuscat"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


</body>
</html>
